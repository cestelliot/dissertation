<!DOCTYPE html>
<html>
  <head>
    <title>Common Ground Experiment</title>
    <script src='jspsych/jspsych.js'></script>
    <script src='jspsych/plugins/jspsych-html-keyboard-response.js'></script>
    <script src="jspsych/plugins/jspsych-survey-multi-choice.js"></script>
    <script src='jspsych/plugins/jspsych-survey-text.js'></script>
    <script src='jspsych/plugins/jspsych-cue-target.js'></script>
    <script src="jspsych/plugins/jspsych-external-html.js"></script>
    <script src='jspsych/plugins/jspsych-survey-likert.js'></script>
    <script src='jspsych/libraries/p5.min.js'></script>
    <script src='jspsych/libraries/p5.dom.js'></script>
    <script src='jspsych/libraries/d3.min.js'></script>
    <script src='jspsych/libraries/lodash.js'></script>
    <script src='jspsych/libraries/jquery-3.4.1.js'></script>
    <link href='jspsych/css/jspsych.css' rel='stylesheet' type='text/css'></link>
  </head>
  <body></body>
  <script>

    var timeline = [];

    /*welcome message trial*/
    var welcome = {
      type:'html-keyboard-response',
      stimulus: 'Welcome to the experiment. Press any key to begin.'
    };

    /* define instructions trial */
    var instructions_1 = {
      type: "html-keyboard-response",
      stimulus:"<p>You will play a communication game set in pairs where you will have to guess different words.</p>"+
      "<p> Sometimes you will be the <strong> speaker </strong> and sometimes you will be the <strong>listener.</strong></p>"
    }

    var instructions_2 = {
      type: "html-keyboard-response",
      stimulus:"<p>If you are the <strong> speaker</strong>, you will:</p>"+
      "<p> 1. Give a one word clue to the listener to guess a word.</p>"+
      "<p> 2. Rate how accurate the listener's guess was. (0 being not all accurate and 10 the correct target).</p>"+
      "<p> 3. Either if the listener's guess was correct or incorrect, you will swap roles."+
      "<p> There will be another chance to guess the word</p>"
    }

    var instructions_3 = {
      type: "html-keyboard-response",
      stimulus:"<p>If you are the <strong> listener</strong>, you will:</p>"+
      "<p> 1.Type the target word you think the speaker is trying to convey. .</p>"+
      "<p> 2. Wait for the speaker's rate to see if you guessed correctly or not.</p>"+
      "<p> 3. Either if the listener's guess was correct or incorrect, you will swap roles."+
      "<p> There will be another chance to guess the word</p>"
    }

    var instructions_4 = {
      type: "html-keyboard-response",
      stimulus:"<p> Press any key to do a quick questionnaire to know if you got the instructions right</p>"
    };

    var instructions = {
      timeline: [instructions_1,instructions_2, instructions_3, instructions_4],
    }

    //questionnaire
    var options = ["Correct", "Incorrect", "Don't know"];

    var questions = {
      type: 'survey-multi-choice',
      questions: [{prompt: "I am going to swap roles between speaker and listener", options: options, required: true} ,
                  {prompt: "I can provide two-word clues to the listener.", options: options, required: true} ,
                  {prompt:  "If I am the speaker, I can see what the lister guessed", options: options, required: true},
                  {prompt: "I will rate the listener's response from 0 to 5", options: options, required: true},
                  {prompt: "I can see the speaker's rating of my guess",options: options, required: true},
                  {prompt: "I will swap roles after the speaker's rate of the listener's guess",options: options, required: true}],
                  on_finish: function(data){
                    data.correct_responses =  "{\"Q0\":\"Correct\",\"Q1\":\"Incorrect\",\"Q2\":\"Correct\",\"Q3\":\"Incorrect\",\"Q4\":\"Correct\",\"Q5\":\"Correct\"}",
                    data.correct = data.responses == data.correct_responses
                  },
    };

    var question_wrong = {
      type: 'html-keyboard-response',
      stimulus: 'Unfortunately, you got some questions wrong. Press any key to reread the instructions and try again.'
    };

    var if_wrong = {
      timeline: [question_wrong, instructions],
      conditional_function: function(){
        var data = jsPsych.data.get().last(1).values()[0];
        if (data.correct == false){
          return true;
        } else {
          return false;
        }
      }
    };

    var questionnaire ={
      timeline: [questions, if_wrong]
    };

    //trial
    var trial_intro_speaker = {
      type: 'html-keyboard-response',
      stimulus: 'You got all the questions right! Now, we will do a trial run, for the first round you will be the <strong>speaker</strong>'
    };

    //Justin stuff
    var cues = [
      {qNo: 0, target: 'Bank'},
    //  {qNo: 1, target: 'Butter'},
    //  {qNo: 2, target: 'Seek'}
    ]

    var cueshuffle = jsPsych.randomization.repeat(cues, 1)

    var cue_target = {
      type: 'cue-target',
      timeline: cueshuffle,
      post_trial_gap: 600,
    };

    var waitplease = {
      type: 'html-keyboard-response',
      stimulus: 'Your partner is making their guess, please wait.'
    };

    var how_good = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10']

    var rater = {
      type: 'survey-likert',
      questions: [{prompt: 'The target was blah and your partner said bloo. How close is this?', labels: how_good}],
    };

    var speaker = {
      timeline: [trial_intro_speaker, cue_target, waitplease, rater],
    };

    //trial intro receiver
    var trial_intro_listener = {
      type: 'html-keyboard-response',
      stimulus: 'Now we are swapping roles. For this round you will be the <strong>listener</strong>'
    };

    var waitplease2 = {
      type: 'html-keyboard-response',
      stimulus: 'Your partner is thinking of a word, please wait.'
    };

    var target_cue = {
      type: 'cue-target',
      preamble: 'Your partner sent you this clue. What do you think the original target was?',
      target: 'Money',
      qNo: 0,
      post_trial_gap: 600,
    };

    var waitplease3 = {
      type: 'html-keyboard-response',
      stimulus: 'Your partner is rating your response, please wait.',
    };

    var rated = {
      type: 'html-keyboard-response',
      stimulus:
      "<p> The speaker has rated your answer with an <b>8</b></p>"+
      "<p> Don't worry you might have another chance to guess the word. For now there will be another word to guess.<p/>"+
      "<p> Press any key to start the experiment</p>"+
      "<p> Have fun!</p>"
    };

    var listener = {
      timeline: [trial_intro_listener, waitplease2, target_cue, waitplease3, rated]
    };


    timeline.push(welcome);
    timeline.push(instructions);
    timeline.push(questionnaire);
    timeline.push(speaker);
    timeline.push(listener);



    /*start Experiment*/
    jsPsych.init({
        default_iti: 500,
        timeline: timeline,
        exclusions: {
          min_width: 800,
          min_height: 600
        },
        // show_progress_bar: true,
        // auto_update_progress_bar: false,
        on_finish: function(){
          jsPsych.data.displayData();
        }
    });

  </script>
</html>
